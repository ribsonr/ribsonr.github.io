<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="google-signin-client_id"
      content="1069265240772-r38r32gaj3jfaf72q6h07oh0mk06nvdb.apps.googleusercontent.com"
    />
    <title>Login</title>
    <style type="text/css">
      :root {
        --primary-dark-color: #14183a;
        --primary-color: #5c4ef7;
        --background-color: #fff;
        --dark-surface-color: #e0dff8;
        --surface-color: #f7f7fa;
        --light-font-color: #798597;
        --error-color: #eb4747;
        --primary-font-family: sans-serif;
      }
      body {
        font-family: var(--primary-font-family);
        color: var(--primary-dark-color);
        background-color: var(--surface-color);
        margin: 0px;
      }
      .main-container {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        width: 100%;
      }
      .login-container {
        padding: 2em;
        width: 25%;
        min-width: 300px;
        background-color: var(--background-color);
        border-radius: 16px;
        box-shadow: 0px 6px 14px 0px var(--dark-surface-color);
      }
      .login-button {
        margin-top: 1em;
      }
    </style>
    <!-- <script type="text/javascript" src="./scripts/common.js"></script> -->
    <!-- <script type="text/javascript" src="./components/form.js"></script> -->
    <script type="text/javascript">
      const baseURL = "http://localhost:23553/v1";
      let url = new URL(window.location.href);
      let urlParams;
      (window.onpopstate = function () {
        var match,
          pl = /\+/g, // Regex for replacing addition symbol with a space
          search = /([^&=]+)=?([^&]*)/g,
          decode = function (s) {
            return decodeURIComponent(s.replace(pl, " "));
          },
          query = window.location.search.substring(1);

        urlParams = {};
        while ((match = search.exec(query)))
          urlParams[decode(match[1])] = decode(match[2]);
      })();
      const post = async (url, PAYLOAD = {}, isAuthenticated = true) => {
        const requestURL = new URL(`${baseURL}${url}`);
        try {
          let response = await fetch(requestURL, {
            method: "POST",
            body: JSON.stringify(PAYLOAD),
            headers: {
              "content-type": "application/json",
              ...(isAuthenticated
                ? {
                    "x-access-token": localStorage.getItem("user-access-token"),
                  }
                : {}),
            },
          });
          if (response.ok) {
            const result = await response.json();
            return result.data;
          } else {
            throw await response.json();
          }
        } catch (e) {
          throw e.message;
        }
      };

      const loginHandler = async () => {
        let buttonElement = document.querySelector("primary-button");
        let emailElement = document.getElementById("email");
        let passwordElement = document.getElementById("password");
        try {
          buttonElement.loading = true;
          if (emailElement.value == "") {
            emailElement.error = "Invalid email";
            throw "Invalid email";
          } else {
            emailElement.error = "";
          }
          if (passwordElement.value == "") {
            passwordElement.error = "Invalid password";
            throw "Invalid password";
          } else {
            passwordElement.error = "";
          }
          const response = await post(
            "/session/login",
            {
              email: email.value,
              password: password.value,
            },
            false
          );
          localStorage.setItem("user-access-token", response.access_token);
          buttonElement.loading = false;
          if (urlParams.key) getAccess();
          else window.location.replace("user-console.html");
        } catch (error) {
          showError(error);
          buttonElement.loading = false;
        }
      };
      const getAccess = async () => {
        if (localStorage.getItem("user-access-token")) {
          if (urlParams.key) {
            try {
              const response = await post(`/session?key=${urlParams.key}`);
              window.location.replace(
                response.redirect_url +
                  `?access_token=${response.access_token}&id_token=${response.id_token}`
              );
            } catch (error) {}
          } else {
            window.location.replace("user-console.html");
          }
        }
      };
      window.onload = getAccess();
    </script>
  </head>
  <body>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script>
      /*
       * Create form to request access token from Google's OAuth 2.0 server.
       */
      function oauthSignIn() {
        // Google's OAuth 2.0 endpoint for requesting an access token
        var oauth2Endpoint = "https://accounts.google.com/o/oauth2/v2/auth";

        // Create <form> element to submit parameters to OAuth 2.0 endpoint.
        var form = document.createElement("form");
        form.setAttribute("method", "GET"); // Send as a GET request.
        form.setAttribute("action", oauth2Endpoint);

        // Parameters to pass to OAuth 2.0 endpoint.
        var params = {
          client_id:
            "1069265240772-9cmb4932n2p3gm5n31g9kv5udes9v65o.apps.googleusercontent.com",
          redirect_uri: "http://127.0.0.1:8081/sample.html",
          response_type: "token",
          scope: "profile email", // Updated scope for basic profile info
          include_granted_scopes: "true",
          state: "pass-through value",
        };

        // Add form parameters as hidden input values.
        for (var p in params) {
          var input = document.createElement("input");
          input.setAttribute("type", "hidden");
          input.setAttribute("name", p);
          input.setAttribute("value", params[p]);
          form.appendChild(input);
        }

        // Add form to page and submit it to open the OAuth 2.0 endpoint.
        document.body.appendChild(form);
        form.submit();
      }
      function onSignIn(googleUser) {
        console.log("Sign in successfully");
        var profile = googleUser.getBasicProfile();
        console.log("ID: " + profile.getId()); // Do not send to your backend! Use an ID token instead.
        console.log("Name: " + profile.getName());
        console.log("Image URL: " + profile.getImageUrl());
        console.log("Email: " + profile.getEmail()); // This is null if the 'email' scope is not present.
      }
      function signOut() {
        var auth2 = gapi.auth2.getAuthInstance();
        auth2.signOut().then(function () {
          console.log("User signed out.");
        });
      }
    </script>
    <div class="main-container">
      <div class="login-container">
        <h3>Login</h3>
        <!-- <input-field
          label="Email"
          placeholder="Enter Email"
          value=""
          id="email"
        ></input-field>
        <input-field
          label="Password"
          placeholder="Enter Password"
          value=""
          type="password"
          id="password"
        ></input-field> -->
        <div style="margin-top: 2em">
          <primary-button
            class="login-button"
            onPress="loginHandler()"
            value="Sign in"
          ></primary-button>
          <div class="g-signin2" data-onsuccess="onSignIn"></div>
        </div>
      </div>
    </div>
  </body>
</html>
